<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}–ê–Ω–µ–∫–¥–æ—Ç—ã - –õ—É—á—à–∏–µ —à—É—Ç–∫–∏ –∏ –∞–Ω–µ–∫–¥–æ—Ç—ã{% endblock %}</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'jokes/style.css' %}">
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <a href="{% url 'jokes:home' %}" class="logo">–ê–Ω–µ–∫–¥–æ—Ç—ã 2</a>
                <nav>
                    <ul>
                        <li><a href="{% url 'jokes:home' %}">–ì–ª–∞–≤–Ω–∞—è</a></li>
                        <li><a href="{% url 'jokes:list' %}">–í—Å–µ –∞–Ω–µ–∫–¥–æ—Ç—ã</a></li>
                        <li><a href="{% url 'jokes:contact' %}">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a></li>
                        <li><a href="#" onclick="showRandomJoke()" id="random-joke">–°–ª—É—á–∞–π–Ω—ã–π</a></li>
                        {% if user.is_authenticated %}
                            <li><a href="{% url 'jokes:logout' %}">–í—ã–π—Ç–∏ ({{ user.username }})</a></li>
                        {% else %}
                            <li><a href="{% url 'jokes:login' %}">–í–æ–π—Ç–∏</a></li>
                            <li><a href="{% url 'jokes:register' %}">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a></li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            {% block content %}
            {% endblock %}
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 –õ–∞–±–∞ web-–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ - –õ—É—á—à–∏–µ —à—É—Ç–∫–∏ –∏ –∞–Ω–µ–∫–¥–æ—Ç—ã</p>
            {% if user.is_staff %}
                <p><a href="/admin/" style="color: #ccc;">–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</a></p>
            {% endif %}
        </div>
    </footer>

    <!-- Random Joke Modal -->
    <div id="randomJokeModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div style="background-color: white; margin: 15% auto; padding: 20px; border-radius: 10px; width: 80%; max-width: 600px; position: relative;">
            <span onclick="closeRandomJoke()" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
            <h2>üé≤ –°–ª—É—á–∞–π–Ω—ã–π –∞–Ω–µ–∫–¥–æ—Ç</h2>
            <div id="randomJokeContent" style="margin: 20px 0; font-size: 1.1rem; line-height: 1.6;"></div>
            <div id="randomJokeCategory" style="margin: 10px 0;"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="showRandomJoke()" class="btn btn-primary">–ï—â–µ –æ–¥–∏–Ω –∞–Ω–µ–∫–¥–æ—Ç</button>
                <button onclick="closeRandomJoke()" class="btn btn-secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <script src="{% static 'jokes/script.js' %}"></script>
    <script>
        // Get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function rateJoke(jokeId, action) {
            const csrftoken = getCookie('csrftoken');
            
            fetch(`/rate/${jokeId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrftoken
                },
                body: `action=${action}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.rating !== undefined) {
                    // Update all rating displays for this joke across the page
                    const ratingElements = document.querySelectorAll(`#rating-${jokeId}`);
                    ratingElements.forEach(element => {
                        element.textContent = data.rating;
                    });
                }
            })
            .catch(error => {
                console.error('Error rating joke:', error);
            });
        }

        function showRandomJoke() {
            fetch('/random/')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('–ê–Ω–µ–∫–¥–æ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!');
                    return;
                }

                document.getElementById('randomJokeContent').innerHTML = data.content.replace(/\n/g, '<br>');
                document.getElementById('randomJokeCategory').innerHTML = `<span class="category-tag">${data.category}</span>`;
                document.getElementById('randomJokeModal').style.display = 'block';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–Ω–µ–∫–¥–æ—Ç–∞');
            });
        }

        function closeRandomJoke() {
            document.getElementById('randomJokeModal').style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('randomJokeModal');
            if (event.target === modal) {
                closeRandomJoke();
            }
        }

        // Update all visible joke ratings every 30 seconds
        function updateAllRatings() {
            const ratingElements = document.querySelectorAll('[id^="rating-"]');
            const jokeIds = Array.from(ratingElements).map(el => el.id.replace('rating-', ''));
            
            // Remove duplicates
            const uniqueJokeIds = [...new Set(jokeIds)];
            
            uniqueJokeIds.forEach(jokeId => {
                fetch(`/joke/${jokeId}/rating/`)
                .then(response => response.json())
                .then(data => {
                    if (data.rating !== undefined) {
                        const ratingElems = document.querySelectorAll(`#rating-${jokeId}`);
                        ratingElems.forEach(elem => {
                            elem.textContent = data.rating;
                        });
                    }
                })
                .catch(error => {
                    console.error('Error updating rating:', error);
                });
            });
        }

        // Update ratings every 1 second
        setInterval(updateAllRatings, 1000);
    </script>
</body>
</html>